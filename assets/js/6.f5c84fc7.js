(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{453:function(s,a,t){s.exports=t.p+"assets/img/2022-06-13-20-33-35.2a8ffa2b.png"},454:function(s,a,t){s.exports=t.p+"assets/img/2022-06-13-20-33-59.ad17803f.png"},455:function(s,a,t){s.exports=t.p+"assets/img/2022-06-13-20-36-14.2d46f918.png"},456:function(s,a,t){s.exports=t.p+"assets/img/2022-06-13-20-36-28.ca07cf2a.png"},457:function(s,a,t){s.exports=t.p+"assets/img/2022-06-13-21-13-10.949d3778.png"},458:function(s,a,t){s.exports=t.p+"assets/img/2022-06-13-20-36-54.bc811502.png"},522:function(s,a,t){"use strict";t.r(a);var e=t(21),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"k8s-service들에-대한-이야기"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#k8s-service들에-대한-이야기"}},[s._v("#")]),s._v(" k8s Service들에 대한 이야기")]),s._v(" "),e("ul",[e("li",[s._v("k8s svc에 대한 정의와 어디에 사용 하는지에 대한 설명을 적어봅니다.")])]),s._v(" "),e("h1",{attrs:{id:"service"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#service"}},[s._v("#")]),s._v(" Service")]),s._v(" "),e("blockquote",[e("p",[s._v("Pod은 자체 IP를 가지고 다른 Pod과 통신할 수 있지만, 쉽게 사라지고 생성되는 특징 때문에 직접 통신하는 방법은 권장하지 않고 있다.\nk8s는 Pod과 직접 통신하는 방법 대신, 별도의 고정된 IP를 가진 서비스를 만들고 그 서비스를 통해 Pod에 접근하는 방식을 사용 하고 있다.\n그걸 할 수 있도록 도와 주는게 Service이다")])]),s._v(" "),e("p",[e("img",{attrs:{src:t(453),alt:"",loading:"lazy"}})]),s._v(" "),e("p",[s._v("이런 개념은 처음 접하였을때 어려웠다!\n개념도 생소하고 노출 범위에 따라 "),e("code",[s._v("CluterIP")]),s._v(", "),e("code",[s._v("NodePort")]),s._v(", "),e("code",[s._v("LoadBalancer")]),s._v(" 으로 나누어져 더욱 어렵게 되어있었다.")]),s._v(" "),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[s._v("Note")]),s._v(" "),e("p",[s._v("서비스 종류 중에 "),e("code",[s._v("ExternalName")]),s._v("도 있지만 여기서는 다루지 않았다. 중요 3총사만 확인하고 남겨본다.")])]),s._v(" "),e("h2",{attrs:{id:"service-clusterip-만들기"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#service-clusterip-만들기"}},[s._v("#")]),s._v(" Service(ClusterIP) 만들기")]),s._v(" "),e("p",[s._v("ClusterIP는 클러스터 내부에 새로운 IP를 할당하고, 여러 개의 Pod을 바라보는 로드밸런서 기능을 제공한다.\n그리고 서비스 이름을 내부 도메인 서버에 등록하여 Pod 간에 서비스 이름으로 통신할 수 있다.")]),s._v(" "),e("p",[s._v("Backend DB 중에 redis를 통해 예제를 만들어보았다.")]),s._v(" "),e("div",{staticClass:"language-yml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" redis\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tier")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" db\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tier")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" db\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" redis\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" redis\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containerPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n              "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" redis\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tier")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" db\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br")])]),e("p",[s._v("redis를 먼저 실행 해서 만들어보자.")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("$ kubectl apply -f test-redis-svc.yml\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Pod, ReplicaSet, Deployment, Service 상태 확인")]),s._v("\n$ kubectl get all\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("em",[s._v("실행 결과")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("NAME                         READY   STATUS    RESTARTS   AGE\npod/redis-67d485db42-mf5w5   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          24s\n\nNAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("    AGE\nservice/kubernetes   ClusterIP   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.76")]),s._v(".0.1       "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("/TCP    19h\nservice/redis        ClusterIP   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.103")]),s._v(".50.52   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("/TCP   24s\n\nNAME                    READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/redis   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("            "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("           24s\n\nNAME                               DESIRED   CURRENT   READY   AGE\nreplicaset.apps/redis-67d485db42   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       24s\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("p",[s._v("redis Deployment와 Service가 생성된 것을 볼 수 있다.")]),s._v(" "),e("p",[e("img",{attrs:{src:t(454),alt:"",loading:"lazy"}})]),s._v(" "),e("p",[s._v("같은 클러스터에서 생성된 Pod이라면 "),e("code",[s._v("redis")]),s._v("라는 도메인으로 redis Pod에 접근 할 수 있다. ("),e("code",[s._v("redis.default.svc.cluster.local")]),s._v("로도 접근가능 하다. 서로 다른 namespace와 cluster를 구분할 수 있다.)")]),s._v(" "),e("p",[s._v("CluterIP 서비스의 설정을 살펴보자.")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("Define")]),s._v(" "),e("th",[s._v("Description")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[e("code",[s._v("spec.ports.port")])]),s._v(" "),e("td",[s._v("서비스가 생성할 Port")])]),s._v(" "),e("tr",[e("td",[e("code",[s._v("spec.ports.targetPort")])]),s._v(" "),e("td",[s._v("서비스가 접근할 Pod의 Port (기본: port랑 동일)")])]),s._v(" "),e("tr",[e("td",[e("code",[s._v("spec.selector")])]),s._v(" "),e("td",[s._v("서비스가 접근할 Pod의 label 조건")])])])]),s._v(" "),e("p",[e("code",[s._v("redis Service")]),s._v("의 "),e("code",[s._v("selector")]),s._v("는 redis Deployment에 정의한 label을 사용했기 때문에 해당 Pod을 가리킨다.\n그리고 해당 Pod을 6379 포트로 연결하였다.")]),s._v(" "),e("p",[s._v("이제 redis에 접근할 test 앱을 deployment로 만든다.")]),s._v(" "),e("div",{staticClass:"language-yml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tier")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" app\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tier")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" app\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ghcr.io/subicura/test"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" REDIS_HOST\n              "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("value")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'redis'")]),s._v("\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" REDIS_PORT\n              "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("value")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'6379'")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br")])]),e("p",[s._v("test app Pod에서 redis Pod으로 접근이 되는지 테스트 해보자.")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("$ kubectl apply -f test-app.yml\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# test app에 접근")]),s._v("\n$ kubectl get po\n$ kubectl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("k get po -lapp"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("test --output"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("jsonpath"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(".items"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(".metadata.name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v(" -- "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl localhost:3000 또는 telnet redis 6379")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  dbsize\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  KEYS *\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  GET count\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("Service를 통해 Pod과 성공적으로 연결할 수 있다.")]),s._v(" "),e("h2",{attrs:{id:"service-생성-flow"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#service-생성-flow"}},[s._v("#")]),s._v(" Service 생성 Flow")]),s._v(" "),e("blockquote",[e("p",[s._v("Service는 각 Pod를 바라보는 로드밸런서 역할을 하면서 내부 도메인서버에 새로운 도메인을 생성한다.\nService가 어떻게 동작하는지 살펴보자.")])]),s._v(" "),e("Mermaid",{attrs:{id:"mermaid-64a5709a","data-code":"sequenceDiagram%0A%20%20autonumber%0A%20%20participant%20A%20as%20API%20Server%0A%20%20participant%20E%20as%20Endpoint%3Cbr%20%2F%3EController%0A%20%20participant%20P%20as%20Kube-Proxy%0A%20%20participant%20D%20as%20CoreDNS%0A%20%20Note%20left%20of%20A%3A%20service.yml%0A%0A%20%20loop%0A%20%20%20%20E-%3E%3EA%3A%20Service%20%EA%B0%90%EC%8B%9C%0A%20%20%20%20E-%3E%3EA%3A%20Endpoint%20%EC%83%9D%EC%84%B1%0A%20%20end%0A%0A%20%20loop%0A%20%20%20%20P-%3E%3EA%3A%20Endpoint%20%EA%B0%90%EC%8B%9C%0A%20%20end%0A%0A%20%20Note%20right%20of%20P%3A%20Endpoint%20%EB%B3%80%EA%B2%BD%EC%8B%9C%3Cbr%20%2F%3Eiptables%20%EC%84%A4%EC%A0%95%0A%0A%20%20loop%0A%20%20%20%20D-%3E%3EA%3A%20Service%20%EA%B0%90%EC%8B%9C%0A%20%20end%0A%0A%20%20Note%20right%20of%20D%3A%20Service%20%EB%B3%80%EA%B2%BD%EC%8B%9C%3Cbr%20%2F%3ECoreDNS%20%EC%84%A4%EC%A0%95%0A"}}),e("ol",[e("li",[e("code",[s._v("Endpoint Controller")]),s._v("는 "),e("code",[s._v("Service")]),s._v("와 "),e("code",[s._v("Pod")]),s._v("을 감시하면서 조건에 맞는 Pod의 IP를 수집")]),s._v(" "),e("li",[e("code",[s._v("Endpoint Controller")]),s._v("가 수집한 IP를 가지고 "),e("code",[s._v("Endpoint")]),s._v(" 생성")]),s._v(" "),e("li",[e("code",[s._v("Kube-Proxy")]),s._v("는 "),e("code",[s._v("Endpoint")]),s._v(" 변화를 감시하고 노드의 iptables을 설정")]),s._v(" "),e("li",[e("code",[s._v("CoreDNS")]),s._v("는 "),e("code",[s._v("Service")]),s._v("를 감시하고 서비스 이름과 IP를 "),e("code",[s._v("CoreDNS")]),s._v("에 추가")])]),s._v(" "),e("p",[e("code",[s._v("iptables")]),s._v("는 커널"),e("sup",[s._v("kernel")]),s._v(" 레벨의 네트워크 도구이고 "),e("code",[s._v("CoreDNS")]),s._v("는 빠르고 편리하게 사용할 수 있는 클러스터 내부용 도메인 네임 서버이다. 각각의 역할은 "),e("code",[s._v("iptables")]),s._v(" 설정으로 여러 IP에 트래픽을 전달하고 "),e("code",[s._v("CoreDNS")]),s._v("를 이용하여 IP 대신 도메인 이름을 사용한다.")]),s._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[s._v("Tips")]),s._v(" "),e("p",[s._v("iptables는 규칙이 많아지면 성능이 느려지는 이슈가 있어, "),e("code",[s._v("ipvs")]),s._v("를 사용하는 옵션도 있다.")])]),s._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[s._v("Tips")]),s._v(" "),e("p",[s._v("CoreDNS는 클러스터에서 호환성을 위해 "),e("code",[s._v("kube-dns")]),s._v("라는 이름으로 생성된다.")])]),s._v(" "),e("p",[s._v("갑자기 Endpoint가 나왔다. Endpoint는 서비스의 접속 정보를 가지고 있다.")]),s._v(" "),e("p",[s._v("Endpoint의 상태를 살펴보면 아래와 같이 볼 수 있다.")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("$ kubectl get endpoints\n$ kubectl get ep "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#줄여서")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis Endpoint 확인")]),s._v("\n$ kubectl describe ep/redis\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[e("em",[s._v("실행 결과")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("Name:         redis\nNamespace:    default\nLabels:       "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nAnnotations:  endpoints.kubernetes.io/last-change-trigger-time: "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nSubsets:\n  Addresses:          "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".0.2\n  NotReadyAddresses:  "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n  Ports:\n    Name     Port  Protocol\n    ----     ----  --------\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("unset"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("  TCP\nEvents:  "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("p",[s._v("Endpoint Addresses 정보에 Redis Pod의 IP가 보이게 된다. (Replicas가 여러개였다면 여러 IP가 보인다.)")]),s._v(" "),e("h2",{attrs:{id:"service-nodeport-만들기"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#service-nodeport-만들기"}},[s._v("#")]),s._v(" Service(NodePort) 만들기")]),s._v(" "),e("p",[e("code",[s._v("CluterIP")]),s._v("는 클러스터 내부에서만 접근할 수 있다.\n클러스터 외부(노드)에서 접근할 수 있도록 "),e("code",[s._v("NodePort")]),s._v(" 서비스를 만들어보자.")]),s._v(" "),e("div",{staticClass:"language-yml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("np\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NodePort\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodePort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("31001")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tier")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" app\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("table",[e("thead",[e("tr",[e("th",[s._v("Define")]),s._v(" "),e("th",[s._v("Description")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[e("code",[s._v("spec.ports.nodePort")])]),s._v(" "),e("td",[s._v("Node에 오픈할 Port (미지정시 30000-32768 중에 자동 할당됨)")])])])]),s._v(" "),e("p",[e("code",[s._v("test app")]),s._v("을 해당 노드의 31001으로 오픈하였다.")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("$ kubectl apply -f test-nodeport.yml\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 서비스 상태 확인")]),s._v("\n$ kubectl get svc\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("em",[s._v("실행 결과")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("          AGE\ntest-np   NodePort    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.101")]),s._v(".168.120   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v(":31001/TCP   54s\nkubernetes   ClusterIP   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.76")]),s._v(".0.1        "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("/TCP          19h\nredis        ClusterIP   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.103")]),s._v(".50.52    "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("/TCP         40m\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("code",[s._v("minikube ip")]),s._v("로 테스트 클러스터의 노드 IP를 구하고 31001으로 접근해보자.")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".64.4:31001\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[s._v("Note")]),s._v(" "),e("p",[s._v("Docker driver를 사용중이라면 "),e("code",[s._v("minikube service test-np")]),s._v(" 명령어를 이용하여 접속하면 된다.")])]),s._v(" "),e("p",[e("img",{attrs:{src:t(455),alt:"",loading:"lazy"}})]),s._v(" "),e("p",[e("code",[s._v("NodePort")]),s._v("는 클러스터의 모든 노드에 포트를 오픈하여 접근 할 수 있도록 한다.\n지금은 하나의 노드밖에 없지만 여러 개의 노드가 있다면 아무 노드로 접근해도 지정한 Pod으로 쏘옥 접근할 수 있다.")]),s._v(" "),e("p",[e("img",{attrs:{src:t(456),alt:"",loading:"lazy"}})]),s._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[s._v("Tips")]),s._v(" "),e("p",[s._v("NodePort는 CluterIP의 기능을 기본으로 포함한다.")])]),s._v(" "),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[s._v("Note")]),s._v(" "),e("p",[s._v("Type=NodePort인 서비스로 보내진 패킷은 소스 NAT가 기본으로 적용된다. 그래서 명심할 것은 "),e("code",[s._v("NodePort")]),s._v("로 들어온 요청은 정확한 클라이언트 IP 주소가 아니고, 클러스터 내부 IP 주소가 될 수 있다.\n시각적으로 "),e("img",{attrs:{src:t(457),alt:"",loading:"lazy"}})]),s._v(" "),e("p",[s._v("이를 피하기 위해 "),e("code",[s._v("externalTrafficPolicy: Local")]),s._v("옵션을 사용 해야함을 잊지 말자.")])]),s._v(" "),e("h2",{attrs:{id:"service-loadbalancer-만들기"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#service-loadbalancer-만들기"}},[s._v("#")]),s._v(" Service(LoadBalancer) 만들기")]),s._v(" "),e("p",[s._v("NodePort의 단점은 노드가 사라졌을 때 자동으로 다른 노드를 통해 접근이 불가능하다는 점이다.\n예를 들어, 3개의 노드가 있다면 3개 중에 아무 노드로 접근해도 "),e("code",[s._v("NodePort")]),s._v("로 연결할 수 있지만 어떤 노드가 살아 있는지는 알 수는 없다.")]),s._v(" "),e("p",[e("img",{attrs:{src:t(458),alt:"",loading:"lazy"}})]),s._v(" "),e("p",[s._v("자동으로 살아 있는 노드에 접근하기 위해 모든 노드를 바라보는 "),e("code",[s._v("Load Balancer")]),s._v("가 필요하다.\nClient는 NodePort에 직접 요청을 보내는 것이 아니라 "),e("code",[s._v("Load Balancer")]),s._v("에 요청하고 Load Balancer가 알아서 살아 있는 노드에 접근하면 NodePort의 단점을 없앨 수 있다.")]),s._v(" "),e("p",[s._v("Load Balancer를 생성해 보자.")]),s._v(" "),e("div",{staticClass:"language-yml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("lb\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" LoadBalancer\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tier")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" app\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("$ kubectl apply -f test-lb.yml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("em",[s._v("실행 결과")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("NAME         TYPE           CLUSTER-IP       EXTERNAL-IP   PORT"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("           AGE\ntest-lb   LoadBalancer   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.109")]),s._v(".50.21   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("pending"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v(":31535/TCP   50s\ntest-np   NodePort       "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.101")]),s._v(".168.120   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v(":31001/TCP    54m\nkubernetes   ClusterIP      "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.76")]),s._v(".0.1        "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("/TCP           20h\nredis        ClusterIP      "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.103")]),s._v(".50.52    "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("/TCP          60m\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("test-lb가 생성되었지만, "),e("code",[s._v("EXTERNAL-IP")]),s._v("가 "),e("code",[s._v("<pending>")]),s._v("인 것을 확인할 수 있다.\n하지만 "),e("code",[s._v("Load Balancer")]),s._v("는 "),e("code",[s._v("AWS")]),s._v(", "),e("code",[s._v("Google Cloud")]),s._v(", "),e("code",[s._v("Azure")]),s._v(" 같은 클라우드 환경이 아니면 사용이 제한적일 수 있다.\n특정 서버(Node)를 가리키는 무언가(Load Balancer)가 필요한데 이런 "),e("code",[s._v("무언가")]),s._v("가 가상머신이나 로컬 서버에는 존재하지 않기 때문이다.")]),s._v(" "),e("h3",{attrs:{id:"minikube에-가상-loadbalancer-만들기"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#minikube에-가상-loadbalancer-만들기"}},[s._v("#")]),s._v(" minikube에 가상 LoadBalancer 만들기")]),s._v(" "),e("p",[s._v("Load Balancer를 사용할 수 없는 환경에서 가상 환경을 만들어 주는 것이 "),e("code",[s._v("MetalLB")]),s._v("라는 것이다. minikube에서는 현재 떠 있는 노드를 Load Balancer로 설정한다. minikube의 "),e("code",[s._v("addons")]),s._v(" 명령어로 활성화할 수 있다.")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("minikube addons "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" metallb\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("그리고 "),e("code",[s._v("minikube ip")]),s._v("명령어로 확인한 IP를 ConfigMap으로 지정해야 한다.")]),s._v(" "),e("p",[s._v("minikube를 이용하여 손쉽게 metallb 설정을 할 수 있다.")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("minikube addons configure metallb\n\n-- Enter Load Balancer Start IP: "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# minikube ip 결과값 입력")]),s._v("\n-- Enter Load Balancer End IP: "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# minikube ip 결과값 입력")]),s._v("\n    ▪ Using image metallb/speaker:latest\n    ▪ Using image metallb/controller:latest\n✅  metallb was successfully configured\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("minikube를 사용하지 않고 직접 ConfigMap을 작성할 수도 있다.")]),s._v(" "),e("div",{staticClass:"language-yml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ConfigMap\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" metallb"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" config\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("data")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("config")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),e("span",{pre:!0,attrs:{class:"token scalar string"}},[s._v("\n    address-pools:\n    - name: default\n      protocol: layer2\n      addresses:\n      - 192.168.64.4/32 # minikube ip")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("$ kubectl apply -f metallb-cm.yml\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 다시 서비스 확인")]),s._v("\n$ kubectl get svc\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("em",[s._v("실행 결과")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("NAME         TYPE           CLUSTER-IP       EXTERNAL-IP   PORT"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("           AGE\ntest-lb   LoadBalancer   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.109")]),s._v(".50.21   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".64.4  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v(":31535/TCP   10m\ntest-np   NodePort       "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.101")]),s._v(".168.120   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v(":31001/TCP    34m\nkubernetes   ClusterIP      "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.76")]),s._v(".0.1        "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("/TCP           21h\nredis        ClusterIP      "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.103")]),s._v(".50.52    "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("/TCP          60m\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("이제 "),e("code",[s._v("192.168.64.4:30000")]),s._v("으로 접근해면")]),s._v(" "),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[s._v("Note")]),s._v(" "),e("p",[s._v("Docker driver를 사용중이라면 "),e("code",[s._v("minikube service test-lb")]),s._v(" 명령어를 이용하여 접속하면 된다.")])]),s._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[s._v("Tips")]),s._v(" "),e("p",[s._v("LoadBalancer는 NodePort의 기능을 기본으로 포함된다.")])]),s._v(" "),e("h2",{attrs:{id:"마무리"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#마무리"}},[s._v("#")]),s._v(" 마무리")]),s._v(" "),e("p",[e("code",[s._v("k8s 서비스")]),s._v("는 low level 수준의 네트워크를 이해하고 성능, 보안 이슈를 신경 써야 한다.\n파고들면 한없이 복잡하고 어려운 부분이 많아서 일단 그렇구나.. 하고 넘어가는게 맘이 편하였다...")]),s._v(" "),e("p",[s._v("실전에선 NodePort와 LoadBalancer를 제한적으로 사용한다.\n보통 웹 애플리케이션을 배포하면 80 또는 443 포트를 사용하고 하나의 포트에서 여러 개의 서비스를 도메인이나 경로에 따라 다르게 연결하기 때문이다.")]),s._v(" "),e("h2",{attrs:{id:"참고"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#참고"}},[s._v("#")]),s._v(" 참고")]),s._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.24/#service-v1-core",target:"_blank",rel:"noopener noreferrer"}},[s._v("Service v1 core"),e("OutboundLink")],1)]),s._v(" "),e("li",[e("a",{attrs:{href:"https://www.edureka.co/blog/kubernetes-networking",target:"_blank",rel:"noopener noreferrer"}},[s._v("k8s 네트워크"),e("OutboundLink")],1)])])],1)}),[],!1,null,null,null);a.default=n.exports}}]);